{% extends "layouts/base.html" %}

{% block title %} Inventory {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css">
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

{% endblock stylesheets %}

{% block content %}

    <main>
        <div class="container-fluid px-4">
            <h1 class="card-title text-center mt-4 mb-4"><i class="fa-solid fa-boxes-stacked"></i> Inventaire du parc informatique</h1>
            <div class="card shadow-sm">
            <div class="card-body">

            {% if request.user.is_active and request.user.is_superuser %}
                <a href="{% url 'add_item' %}" class="btn btn-primary mb-3"><i class="fa-solid fa-circle-plus"></i> Ajouter un élément</a>
            {% endif %}
                <table id="inventoryTable" class="py-4 table table-striped display">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Marque</th>
                            <th>Modèle</th>
                            <th>Numéro de série</th>
                            <th>Attribué à</th>
                            <th>Sites</th>
                            <th>Date d'achat</th>
                            <th>Notes</th>
                            {% if request.user.is_active and request.user.is_superuser %}
                            <th>Actions</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td>{{ item.type.name }}</td>
                            <td>{{ item.brand.name }}</td>
                            <td>{{ item.model }}</td>
                            <td>{{ item.serial_number }}</td>
                            <td>{{ item.assigned_to|default:"Non attribué" }}</td>
                             <td>
                                {% for s in item.site.all %}
                                 <span class="badge bg-info text-dark">{{ s.name }}</span>
                                 {% if not forloop.last %}{% endif %}
                                {% empty %}
                                    Non attribué
                                {% endfor %}
                            </td>
                            <td>{{ item.purchase_date|date:"d/m/Y"|default:"N/A" }}</td>
                            <td>{{ item.notes|truncatewords:10|default:"" }}</td>
                            {% if request.user.is_active and request.user.is_superuser %}
                                <td class="action-buttons">
                                    <a href="{% url 'edit_item' item.pk %}" class="btn btn-sm btn-warning me-1" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ item.pk }}" title="Supprimer">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                <!-- Modal de confirmation -->
                                <div class="modal fade" id="deleteModal{{ item.pk }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ item.pk }}" aria-hidden="true">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="deleteModalLabel{{ item.pk }}">Confirmer la suppression</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body">
                                                Voulez-vous vraiment supprimer l'élément <strong>{{ item }}</strong> ?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                                                <form method="post" action="{% url 'delete_item' item.pk %}" class="d-inline">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn btn-danger">Supprimer</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        {% endif %}

                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        </div>
    </main>

{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script>
        $(document).ready(function() {
            $('#inventoryTable').DataTable({
<!--                "pageLength": 25,-->
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.4/i18n/fr-FR.json"
                },
                "columnDefs": [
                    { "orderable": false, "targets": 7 } // Désactiver le tri sur la colonne Actions
                ]
            });
        });
    </script>

{% endblock javascripts %}
